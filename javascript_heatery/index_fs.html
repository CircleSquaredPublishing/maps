<!DOCTYPE html>
<html>
<head>
<title>Javascript Heatery Foursquare Data Source</title>
<meta charset="utf-8">
<!-- JQUERY 2.1.4 -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<!-- GOOGLE MAPS V3.EXP INCLUDES VISUALIZATION AND PLACES LIBRARIES  -->
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=false&libraries=visualization,places,geometry"></script>
<!-- BOOTSTRAP 3.3.5 MINIFIED CSS -->
<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />

<link rel="stylesheet" type="text/css" href="css/style.css"/>
</head>
<body>
<div class="navbar navbar-custom navbar-fixed-top">
<div class="navbar-header">
<a class="navbar-brand" href="#">heatery.io</a>
<a class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li class="active"><a href="#">Heatery Map</a></li>
<li><a href="#"><span class="glyphicon glyphicon-user">
</span>&nbsp;&nbsp;Client Portal</a>
</li>
<li><a href="#"><span class="glyphicon glyphicon-log-in">
</span>&nbsp;&nbsp;The Speak Easy&nbsp;&nbsp;&nbsp;&nbsp;</a>
</li>
<li>&nbsp;</li>
</ul>
<div class="form-group" style="margin-right:20px;">
<form class="form-inline" action="" method="post">
<div id="gc-input" class="input-group" style="margin-top:10px; float: right;">
<span class="input-group-btn">
<input class="btn btn-success btn-md" id="locate" value="Find" />
</span>
<input style="width:250px; " id="address" class="form-control" type="text" placeholder="Your Hot Spot." />
</div>
</form>
</div>
</div>
</div>
<div class='main'>
<div>
<div id="map-canvas"></div>
<div class="eventtext">
</div>
</div>
</div>
<br />
<script>
window.onload = getLocation;
var heatmap;
var map;
var myData=[];
var TILE_SIZE = 256;
/*Begin Mercator Projection*/
function bound(value, opt_min, opt_max) {
	if (opt_min !== null) value = Math.max(value, opt_min);
	if (opt_max !== null) value = Math.min(value, opt_max);
	return value;
}
function degreesToRadians(deg) {
	return deg * (Math.PI / 180);
}
function radiansToDegrees(rad) {
	return rad / (Math.PI / 180);
}
function MercatorProjection() {
	this.pixelOrigin_ = new google.maps.Point(TILE_SIZE / 2, TILE_SIZE / 2);
	this.pixelsPerLonDegree_ = TILE_SIZE / 360;
	this.pixelsPerLonRadian_ = TILE_SIZE / (2 * Math.PI);
}
MercatorProjection.prototype.fromLatLngToPoint = function(latLng, opt_point) {
	var me = this;
	var point = opt_point || new google.maps.Point(0, 0);
	var origin = me.pixelOrigin_;
	point.x = origin.x + latLng.lng() * me.pixelsPerLonDegree_;
	var siny = bound(Math.sin(degreesToRadians(latLng.lat())), -0.9999, 0.9999);
	point.y = origin.y + 0.5 * Math.log((1 + siny) / (1 - siny)) * -me.pixelsPerLonRadian_;
	return point;
};
MercatorProjection.prototype.fromPointToLatLng = function(point) {
	var me = this;
	var origin = me.pixelOrigin_;
	var lng = (point.x - origin.x) / me.pixelsPerLonDegree_;
	var latRadians = (point.y - origin.y) / -me.pixelsPerLonRadian_;
	var lat = radiansToDegrees(2 * Math.atan(Math.exp(latRadians)) - Math.PI / 2);
	return new google.maps.LatLng(lat, lng);
};
var desiredRadiusPerPointInMeters = 150;
function getNewRadius() {
	var numTiles = 1 << map.getZoom();
	var center = map.getCenter();
	var moved = google.maps.geometry.spherical.computeOffset(center, 10000, 90); /*1000 meters to the right*/
	var projection = new MercatorProjection();
	var initCoord = projection.fromLatLngToPoint(center);
	var endCoord = projection.fromLatLngToPoint(moved);
	var initPoint = new google.maps.Point(
		initCoord.x * numTiles,
		initCoord.y * numTiles);
	var endPoint = new google.maps.Point(
		endCoord.x * numTiles,
		endCoord.y * numTiles);
	var pixelsPerMeter = (Math.abs(initPoint.x - endPoint.x)) / 10000.0;
	var totalPixelSize = Math.floor(desiredRadiusPerPointInMeters * pixelsPerMeter);
	console.log(totalPixelSize);
	return totalPixelSize;
}
/*End Mercator Projection*/
    
function getLocation() {
	if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(geoSuccess, geoError, {
			maximumAge: 30000,
			timeout: 5000,
			enableHighAccuracy: true
		});
	} else {
		alert("Geolocation is not supported by your browser.");
	}
}
function geoSuccess(position) {
	var lat = position.coords.latitude;
	var lng = position.coords.longitude;
	var loc = new google.maps.LatLng(lat, lng);
	displayMap(position.coords);
	var fb = "https://graph.facebook.com/v2.4/search?&q=restaurant&type=place&center=" + loc + "&distance=5000&fields=talking_about_count,location,name&offset=0&limit=5000&access_token=1452021355091002|x-ZB0iKqWQmYqnJQ-wXoUjl-XtY";
	fb = fb.replace(/[()]/g, "");
	$(document).ready(function() {
		$.ajax({
			url: fb,
			dataType: "text",
			cache: true,
			success: function(data) {
				var restaurantData = $.parseJSON(data);
				var myData = [];
				var gradientNew = ["rgba(0,255,255,0)",
					"rgba(25, 22, 218, 1)", "rgba(17, 191, 225, 1)", "rgba(16, 227, 217, 1)", "rgba(15, 229, 173, 1)", "rgba(14, 231, 128, 1)", "rgba(13, 233, 82, 1)", "rgba(12, 235, 34, 1)", "rgba(37, 237, 11, 1)", "rgba(85, 239, 10, 1)", "rgba(134, 241, 8, 1)", "rgba(185, 243, 7, 1)", "rgba(237, 245, 6, 1)", "rgba(247, 203, 5, 1)", "rgba(249, 152, 3, 1)", "rgba(251, 100, 2, 1)", "rgba(255, 127, 131, 1)", "rgba(253, 47, 1, 1)", "rgba(255, 0, 7, 1)"
				];
				for (var i = 0; i < restaurantData.data.length; i++) {
					var lat = restaurantData.data[i].location.latitude;
					var lng = restaurantData.data[i].location.longitude;
					var wgt = restaurantData.data[i].talking_about_count;
					var latLng = new google.maps.LatLng(lat, lng, wgt);
					myData.push(latLng);
				}
				heatmap = new google.maps.visualization.HeatmapLayer({
					data: myData,
					radius: getNewRadius(),
					opacity: 0.3,
					gradient: gradientNew,
					map: map
				});
			}
		});
	});
}
function geoError(error) {
	switch (error.code) {
		case error.PERMISSION_DENIED:
			alert("The Heatery Map Requires Your Location for Accurate Results");
			break;
		case error.POSITION_UNAVAILABLE:
			alert("Location information is unavailable.")
			break;
		case error.TIMEOUT:
			alert("The request to get user location timed out.")
			break;
		case error.UNKNOWN_ERROR:
			alert("An unknown error occurred.")
			break;
	}
}  
function displayMap(coords) {
	var successPosition = new google.maps.LatLng(coords.latitude, coords.longitude);
	var myOptions = {
		zoom: 14,
		center: successPosition,
		mapTypeId: google.maps.MapTypeId.TERRAIN
	};
	map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);
    
	google.maps.event.addListener(map, 'zoom_changed', function() {
		heatmap.setOptions({
			radius: getNewRadius()
		});
	});
    
    google.maps.event.addListener(map, 'click', function(event) {
		heatmap.setMap(null);
		var lat = event.latLng.lat();
		var lng = event.latLng.lng();
		var loc = new google.maps.LatLng(lat, lng);
		var fb = "https://api.foursquare.com/v2/venues/explore?v=20150918&ll=" + loc + "&radius=5000&section=food&limit=50&novelty=new&client_id=LUDUFON05OQ3US4C0FT0TEKWXKSD0NHIPVGKF0TGUZGY4YUR&client_secret=F2E3NQTQKY3WS1APVGFVA31ESHW2ONNPVNJ11NPYVBV05W2I";
		fb = fb.replace(/[()]/g, "");
		$(document).ready(function() {
			$.ajax({
				url: fb,
				dataType: "text",
				success: function(data) {
					var restaurantData = $.parseJSON(data);
					var myData = [];          
					var gradientNew = ["rgba(0,255,255,0)",
						"rgba(25, 22, 218, 1)", "rgba(17, 191, 225, 1)", "rgba(16, 227, 217, 1)", "rgba(15, 229, 173, 1)", "rgba(14, 231, 128, 1)", "rgba(13, 233, 82, 1)", "rgba(12, 235, 34, 1)", "rgba(37, 237, 11, 1)", "rgba(85, 239, 10, 1)", "rgba(134, 241, 8, 1)", "rgba(185, 243, 7, 1)", "rgba(237, 245, 6, 1)", "rgba(247, 203, 5, 1)", "rgba(249, 152, 3, 1)", "rgba(251, 100, 2, 1)", "rgba(255, 127, 131, 1)", "rgba(253, 47, 1, 1)", "rgba(255, 0, 7, 1)"
					];        
					for (var i = 0; i < restaurantData.data.length; i++) {
						var lat = restaurantData.data[i].location.latitude;
						var lng = restaurantData.data[i].location.longitude;
						var wgt = restaurantData.data[i].talking_about_count;
						var latLng = new google.maps.LatLng(lat, lng, wgt);
						myData.push(latLng);
					}
					heatmap = new google.maps.visualization.HeatmapLayer({
						data: myData,
						radius: getNewRadius(),
						opacity: 0.3,
						gradient: gradientNew,
						map: map
					});
				}
			});
		});
	});

}

/*Geocodes user input*/
$("#locate").click(function(event) {
    var geocoder = new google.maps.Geocoder();
    var address = document.getElementById("address").value;
    geocoder.geocode({
        address: address
    }, function(results, status) {
        var addr_type = results[0].types[0];
        if (status == google.maps.GeocoderStatus.OK)
            ShowLocation(results[0].geometry.location, address, addr_type);
        else
            alert("Geocode was not successful for the following reason: " + status);
    });
});
    
function ShowLocation(latlng, address, addr_type) {
        heatmap.setMap(null);
		map.setCenter(latlng);
		var zoom = 14;
		var fb = "https://graph.facebook.com/v2.4/search?&q=restaurant&type=place&center=" + latlng + "&distance=5000&fields=talking_about_count,location,name&offset=0&limit=5000&access_token=1452021355091002|x-ZB0iKqWQmYqnJQ-wXoUjl-XtY";
		fb = fb.replace(/[()]/g, "");
    
		$(document).ready(function() {
			$.ajax({
				url: fb,
				dataType: "text",
				cache: true,
				success: function(data) {
					var restaurantData = $.parseJSON(data);
					var myData = [];
					var gradientNew = ["rgba(0,255,255,0)",
						"rgba(25, 22, 218, 1)", "rgba(17, 191, 225, 1)", "rgba(16, 227, 217, 1)", "rgba(15, 229, 173, 1)", "rgba(14, 231, 128, 1)", "rgba(13, 233, 82, 1)", "rgba(12, 235, 34, 1)", "rgba(37, 237, 11, 1)", "rgba(85, 239, 10, 1)", "rgba(134, 241, 8, 1)", "rgba(185, 243, 7, 1)", "rgba(237, 245, 6, 1)", "rgba(247, 203, 5, 1)", "rgba(249, 152, 3, 1)", "rgba(251, 100, 2, 1)", "rgba(255, 127, 131, 1)", "rgba(253, 47, 1, 1)", "rgba(255, 0, 7, 1)"
					];
					for (var i = 0; i < restaurantData.data.length; i++) {
						var lat = restaurantData.data[i].location.latitude;
						var lng = restaurantData.data[i].location.longitude;
						var wgt = restaurantData.data[i].talking_about_count;
						var latLng = new google.maps.LatLng(lat, lng, wgt);
						myData.push(latLng);
					}
					heatmap = new google.maps.visualization.HeatmapLayer({
						data: myData,
						radius: getNewRadius(),
						opacity: 0.3,
						gradient: gradientNew,
						map: map
					});
				}
			});
		});
	}

google.maps.event.addDomListener(window, 'load', displayMap);
</script>
</body>
</html>